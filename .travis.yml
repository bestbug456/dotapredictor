language: go
sudo: true
go:
- '1.11'
stages:
  - test
  - name: deploy
    if: branch = master
jobs:
  include:
  - stage: test
    script: 
      - go get -t -v ./... 
      - go test -race
      - go mod vendor
  - stage: deploy
    script:
    - sh ecr_credentials.sh
    - docker --version  # document the version travis is using
    - docker build -t 207595473504.dkr.ecr.eu-central-1.amazonaws.com/dotapredictor:latest .
    - pip install urllib3[secure]
    - pip install --user awscli # install aws cli w/o sudo
    - export PATH=$PATH:$HOME/.local/bin # put aws in the path
    - eval $(aws ecr get-login --region eu-central-1) #needs AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY envvars
    - docker push 207595473504.dkr.ecr.eu-central-1.amazonaws.com/dotapredictor:latest
    - aws ecs update-service --cluster default --service dotapredictor --force-new-deployment